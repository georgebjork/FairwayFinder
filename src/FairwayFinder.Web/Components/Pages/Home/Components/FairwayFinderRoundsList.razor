@using FairwayFinder.Features.Data
@using FairwayFinder.Features.Services
@using FairwayFinder.Features.Services.Interfaces
@inject IRoundService RoundService
@inject NavigationManager NavigationManager

@if (_loading)
{
    <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" class="rz-p-4">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    </RadzenStack>
}
else if (_rounds is null || !_rounds.Any())
{
    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">
        You haven't recorded any rounds yet.
    </RadzenAlert>
}
else
{
    <RadzenDataGrid Data="@_rounds" 
                    TItem="RoundResponse"
                    AllowFiltering="true"
                    FilterMode="FilterMode.Advanced"
                    AllowSorting="true"
                    AllowPaging="true"
                    PageSize="10"
                    PagerHorizontalAlign="HorizontalAlign.Right"
                    ShowPagingSummary="true"
                    PagingSummaryFormat="Displaying page {0} of {1} (total {2} rounds)"
                    RowClick="@OnRowClick"
                    Style="cursor: pointer;">
        <Columns>
            <RadzenDataGridColumn TItem="RoundResponse" Property="DatePlayed" Title="Date Played" Width="150px">
                <Template Context="round">
                    @round.DatePlayed.ToString("MMM dd, yyyy")
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="RoundResponse" Property="CourseName" Title="Course" />
            <RadzenDataGridColumn TItem="RoundResponse" Property="Score" Title="Score" Width="100px" TextAlign="TextAlign.Center" />
        </Columns>
    </RadzenDataGrid>
}

@code {
    [Parameter]
    public string? UserId { get; set; }

    private List<RoundResponse>? _rounds;
    private bool _loading = true;

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(UserId))
        {
            await LoadRoundsAsync();
        }
    }

    private async Task LoadRoundsAsync()
    {
        _loading = true;
        
        if (!string.IsNullOrEmpty(UserId))
        {
            _rounds = await RoundService.GetRoundsByUserIdAsync(UserId);
        }
        
        _loading = false;
    }

    private void OnRowClick(DataGridRowMouseEventArgs<RoundResponse> args)
    {
        if (args.Data is not null)
        {
            NavigationManager.NavigateTo($"/round/{args.Data.RoundId}");
        }
    }
}
