@page "/"
@rendermode InteractiveServer
@layout MainLayout
@attribute [Authorize]
@using System.Security.Claims
@using FairwayFinder.Features.Data
@using FairwayFinder.Features.Services
@using FairwayFinder.Web.Components.Pages.Home.Components
@using Microsoft.AspNetCore.WebUtilities
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IStatsService StatsService
@inject NavigationManager NavigationManager
@inject DialogService DialogService

<PageTitle>Dashboard</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Filters -->
    <RadzenCard class="rz-p-3">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.End" Wrap="FlexWrap.Wrap">
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.Caption" style="color: var(--rz-text-secondary-color);">Round Type</RadzenText>
                <RadzenDropDown TValue="string" 
                                Data="@_roundTypeOptions" 
                                TextProperty="Text" 
                                ValueProperty="Value"
                                @bind-Value="_selectedRoundType"
                                Style="width: 140px;"
                                Change="@OnFilterChanged" />
            </RadzenStack>
            
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.Caption" style="color: var(--rz-text-secondary-color);">From</RadzenText>
                <RadzenDatePicker TValue="DateOnly?" 
                                  @bind-Value="_startDate" 
                                  DateFormat="MM/dd/yyyy"
                                  Style="width: 140px;"
                                  Change="@OnFilterChanged"
                                  AllowClear="true" />
            </RadzenStack>
            
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.Caption" style="color: var(--rz-text-secondary-color);">To</RadzenText>
                <RadzenDatePicker TValue="DateOnly?" 
                                  @bind-Value="_endDate" 
                                  DateFormat="MM/dd/yyyy"
                                  Style="width: 140px;"
                                  Change="@OnFilterChanged"
                                  AllowClear="true" />
            </RadzenStack>
            
            @if (_hasActiveFilters)
            {
                <RadzenButton Text="Clear Filters" 
                              ButtonStyle="ButtonStyle.Light" 
                              Size="ButtonSize.Small"
                              Click="@ClearFilters" />
            }
        </RadzenStack>
    </RadzenCard>
    <!-- Stats Cards -->
    @if (_loading)
    {
        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
            <RadzenCard class="stats-card-loading">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            </RadzenCard>
            <RadzenCard class="stats-card-loading">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            </RadzenCard>
            <RadzenCard class="stats-card-loading">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            </RadzenCard>
        </RadzenStack>
    }
    else if (_stats is not null)
    {
        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
            <FairwayFinderStatsCard 
                Label="Rounds Played" 
                Value="@_stats.TotalRounds.ToString()" />
            
            
            @if (_stats.Average18HoleScore.HasValue)
            {
                <FairwayFinderStatsCard 
                    Label="Average 18 Hole Score" 
                    Value="@(_stats.Average18HoleScore?.ToString("F1") ?? "-")"
                    SubText="@(_stats.Total18HoleRounds + " rounds")">  
                    @if (_stats.Average18HoleScoreTrend.HasValue)
                    {
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem" JustifyContent="JustifyContent.Center">
                            @if (_stats.Average18HoleScoreTrend < 0) {
                                <RadzenIcon Icon="trending_down" IconStyle="IconStyle.Success"/>
                                <RadzenText TextStyle="TextStyle.Caption">
                                    @_stats.Average18HoleScoreTrend.Value
                                </RadzenText>
                            }
                            else
                            {
                                <RadzenIcon Icon="trending_up" IconStyle="IconStyle.Danger"/>
                                <RadzenText TextStyle="TextStyle.Caption">
                                    + @_stats.Average18HoleScoreTrend.Value.ToString("F1")
                                </RadzenText>
                            }
                        </RadzenStack>
                    }
                </FairwayFinderStatsCard>
            }
            
            @if (_stats.Average9HoleScore.HasValue)
            {
                <FairwayFinderStatsCard 
                    Label="Average 9 Hole Score" 
                    Value="@(_stats.Average9HoleScore?.ToString("F1") ?? "-")"
                    SubText="@(_stats.Total9HoleRounds + " rounds")">  
                    @if (_stats.Average9HoleScoreTrend.HasValue)
                    {
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem" JustifyContent="JustifyContent.Center">
                            @if (_stats.Average9HoleScoreTrend < 0) {
                                <RadzenIcon Icon="trending_down" IconStyle="IconStyle.Success"/>
                                <RadzenText TextStyle="TextStyle.Caption">
                                    @_stats.Average9HoleScoreTrend.Value
                                </RadzenText>
                            }
                            else
                            {
                                <RadzenIcon Icon="trending_up" IconStyle="IconStyle.Danger"/>
                                <RadzenText TextStyle="TextStyle.Caption">
                                    + @_stats.Average9HoleScoreTrend.Value.ToString("F1")
                                </RadzenText>
                            }
                        </RadzenStack>
                    }
                </FairwayFinderStatsCard>
            }
            
            
            @if (_stats.Best18HoleRound is not null)
            {
                <FairwayFinderStatsCard 
                    Label="Best Full Round" 
                    Value="@_stats.Best18HoleRound.Score.ToString()"
                    SubText="@_stats.Best18HoleRound.CourseName"
                    OnClick="NavigateToBestFullRound"/>
            }
            
            @if (_stats.Best9HoleRound is not null)
            {
                <FairwayFinderStatsCard 
                    Label="Best Nine Hole Round" 
                    Value="@_stats.Best9HoleRound.Score.ToString()"
                    SubText="@_stats.Best9HoleRound.CourseName"
                    OnClick="NavigateToNineHoleRound"/>
            }
            
            @if (_stats.AdvancedStats.RoundsWithStats > 0)
            {
                @if (_stats.AdvancedStats.FirPercent.HasValue)
                {
                    <FairwayFinderStatsCard 
                        Label="Fairways" 
                        Value="@($"{_stats.AdvancedStats.FirPercent:F1}%")"
                        SubText="@($"{_stats.AdvancedStats.RoundsWithStats} rounds")"
                        OnClick="ShowFirTrendDialog">
                        @if (_stats.AdvancedStats.FirPercentTrend.HasValue)
                        {
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem" JustifyContent="JustifyContent.Center">
                                @if (_stats.AdvancedStats.FirPercentTrend > 0) {
                                    <RadzenIcon Icon="trending_up" IconStyle="IconStyle.Success"/>
                                    <RadzenText TextStyle="TextStyle.Caption">
                                       + @_stats.AdvancedStats.FirPercentTrend.Value.ToString("F1")%
                                    </RadzenText>
                                }
                                else
                                {
                                    <RadzenIcon Icon="trending_down" IconStyle="IconStyle.Danger"/>
                                    <RadzenText TextStyle="TextStyle.Caption">
                                       @_stats.AdvancedStats.FirPercentTrend.Value.ToString("F1")%
                                    </RadzenText>
                                }
                            </RadzenStack>
                        }
                    </FairwayFinderStatsCard>
                }
                
                @if (_stats.AdvancedStats.GirPercent.HasValue)
                {
                    <FairwayFinderStatsCard 
                        Label="Greens" 
                        Value="@($"{_stats.AdvancedStats.GirPercent:F1}%")"
                        SubText="@($"{_stats.AdvancedStats.RoundsWithStats} rounds")"
                        OnClick="ShowGirTrendDialog">
                        @if (_stats.AdvancedStats.GirPercentTrend.HasValue)
                        {
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem" JustifyContent="JustifyContent.Center">
                                @if (_stats.AdvancedStats.GirPercentTrend > 0) {
                                    <RadzenIcon Icon="trending_up" IconStyle="IconStyle.Success"/>
                                    <RadzenText TextStyle="TextStyle.Caption">
                                       + @_stats.AdvancedStats.GirPercentTrend.Value.ToString("F1")%
                                    </RadzenText>
                                }
                                else
                                {
                                    <RadzenIcon Icon="trending_down" IconStyle="IconStyle.Danger"/>
                                    <RadzenText TextStyle="TextStyle.Caption">
                                       @_stats.AdvancedStats.GirPercentTrend.Value.ToString("F1")%
                                    </RadzenText>
                                }
                            </RadzenStack>
                        }
                    </FairwayFinderStatsCard>
                }
                
                @if (_stats.AdvancedStats.Average18HolePutts.HasValue)
                {
                    <FairwayFinderStatsCard 
                        Label="Avg Putts" 
                        Value="@($"{_stats.AdvancedStats.Average18HolePutts:F1}")"
                        SubText="per round"
                        OnClick="ShowPuttsTrendDialog">
                        @if (_stats.AdvancedStats.Average18HolePuttsTrend.HasValue)
                        {
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem" JustifyContent="JustifyContent.Center">
                                @if (_stats.AdvancedStats.Average18HolePuttsTrend < 0) {
                                    <RadzenIcon Icon="trending_down" IconStyle="IconStyle.Success"/>
                                    <RadzenText TextStyle="TextStyle.Caption">
                                       @_stats.AdvancedStats.Average18HolePuttsTrend.Value.ToString("F1")
                                    </RadzenText>
                                }
                                else
                                {
                                    <RadzenIcon Icon="trending_up" IconStyle="IconStyle.Danger"/>
                                    <RadzenText TextStyle="TextStyle.Caption">
                                       + @_stats.AdvancedStats.Average18HolePuttsTrend.Value.ToString("F1")
                                    </RadzenText>
                                }
                            </RadzenStack>
                        }
                    </FairwayFinderStatsCard>
                }
            }
        </RadzenStack>
        
        <!-- Par Type Stats Row -->
        if (_stats.ParTypeScoring.Par3Average.HasValue || _stats.ParTypeScoring.Par4Average.HasValue || _stats.ParTypeScoring.Par5Average.HasValue)
        {
            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
            @if (_stats.ParTypeScoring.Par3Average.HasValue)
            {
                <FairwayFinderStatsCard 
                    Label="Par 3 Avg" 
                    Value="@($"{_stats.ParTypeScoring.Par3Average:F2}")"
                    SubText="@($"{_stats.ParTypeScoring.Par3Count} holes")" />
            }
            
            @if (_stats.ParTypeScoring.Par4Average.HasValue)
            {
                <FairwayFinderStatsCard 
                    Label="Par 4 Avg" 
                    Value="@($"{_stats.ParTypeScoring.Par4Average:F2}")"
                    SubText="@($"{_stats.ParTypeScoring.Par4Count} holes")" />
            }
            
            @if (_stats.ParTypeScoring.Par5Average.HasValue)
            {
                <FairwayFinderStatsCard 
                    Label="Par 5 Avg" 
                    Value="@($"{_stats.ParTypeScoring.Par5Average:F2}")"
                    SubText="@($"{_stats.ParTypeScoring.Par5Count} holes")" />
            }
        </RadzenStack>
        }
    }

    <!-- Charts Row -->
    <RadzenRow Gap="1rem">
        <RadzenColumn Size="12" SizeLG="7">
            <RadzenCard Style="height: 100%;">
                <RadzenText TextStyle="TextStyle.H5" class="rz-mb-4">Score Trend</RadzenText>
                <FairwayFinderScoreTrendChart TrendData="@_stats?.ScoreTrend18Hole" />
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeLG="5">
            <RadzenCard Style="height: 100%;">
                <RadzenText TextStyle="TextStyle.H5" class="rz-mb-4">Scoring Distribution</RadzenText>
                <FairwayFinderScoringDistributionChart Distribution="@_stats?.ScoringDistribution" />
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Recent Rounds & Most Played Courses -->
    <RadzenRow Gap="1rem">
        <RadzenColumn Size="12" SizeLG="8">
            <RadzenCard Style="height: 100%;">
                <RadzenText TextStyle="TextStyle.H5" class="rz-mb-4">Recent Rounds</RadzenText>
                <FairwayFinderRoundsList Rounds="@_stats?.Rounds" />
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeLG="4">
            <RadzenCard Style="height: 100%;">
                <RadzenText TextStyle="TextStyle.H5" class="rz-mb-4">Most Played Courses</RadzenText>
                <FairwayFinderMostPlayedCourses Courses="@_stats?.MostPlayedCourses" />
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

<style>
    .stats-card-loading {
        min-width: 150px;
        min-height: 100px;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

@code {
    private string? _userId;
    private UserStatsResponse? _stats;
    private bool _loading = true;
    
    // Filter state
    private string _selectedRoundType = "all";
    private DateOnly? _startDate;
    private DateOnly? _endDate;
    
    private bool _hasActiveFilters => _selectedRoundType != "all" || _startDate.HasValue || _endDate.HasValue;
    
    private readonly List<object> _roundTypeOptions = new()
    {
        new { Text = "All Rounds", Value = "all" },
        new { Text = "18 Hole", Value = "18" },
        new { Text = "9 Hole", Value = "9" }
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            _userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            
            if (!string.IsNullOrEmpty(_userId))
            {
                // Parse URL query parameters
                ParseQueryParameters();
                
                await LoadStats();
            }
        }
        
        _loading = false;
    }
    
    private void ParseQueryParameters()
    {
        var uri = new Uri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        
        if (query.TryGetValue("type", out var typeValue))
        {
            var type = typeValue.ToString();
            if (type == "18" || type == "9")
            {
                _selectedRoundType = type;
            }
        }
        
        if (query.TryGetValue("from", out var fromValue) && DateOnly.TryParse(fromValue.ToString(), out var startDate))
        {
            _startDate = startDate;
        }
        
        if (query.TryGetValue("to", out var toValue) && DateOnly.TryParse(toValue.ToString(), out var endDate))
        {
            _endDate = endDate;
        }
    }
    
    private void UpdateUrl()
    {
        var queryParams = new Dictionary<string, string?>();
        
        if (_selectedRoundType != "all")
        {
            queryParams["type"] = _selectedRoundType;
        }
        
        if (_startDate.HasValue)
        {
            queryParams["from"] = _startDate.Value.ToString("yyyy-MM-dd");
        }
        
        if (_endDate.HasValue)
        {
            queryParams["to"] = _endDate.Value.ToString("yyyy-MM-dd");
        }
        
        var newUrl = queryParams.Count > 0 
            ? QueryHelpers.AddQueryString("/", queryParams!) 
            : "/";
        
        NavigationManager.NavigateTo(newUrl, replace: true);
    }
    
    private StatsFilter BuildFilter()
    {
        return new StatsFilter
        {
            FullRoundOnly = _selectedRoundType switch
            {
                "18" => true,
                "9" => false,
                _ => null
            },
            StartDate = _startDate,
            EndDate = _endDate
        };
    }
    
    private async Task LoadStats()
    {
        if (string.IsNullOrEmpty(_userId)) return;
        
        var filter = BuildFilter();
        _stats = await StatsService.GetUserStatsAsync(_userId, filter);
    }
    
    private async Task OnFilterChanged()
    {
        _loading = true;
        StateHasChanged();
        
        UpdateUrl();
        await LoadStats();
        
        _loading = false;
    }
    
    private async Task ClearFilters()
    {
        _selectedRoundType = "all";
        _startDate = null;
        _endDate = null;
        
        await OnFilterChanged();
    }

    private void NavigateToBestFullRound()
    {
        if (_stats?.Best18HoleRound is not null)
        {
            NavigationManager.NavigateTo($"/round/{_stats.Best18HoleRound.RoundId}");
        }
    }
    
    private void NavigateToNineHoleRound()
    {
        if (_stats?.Best9HoleRound is not null)
        {
            NavigationManager.NavigateTo($"/round/{_stats.Best9HoleRound.RoundId}");
        }
    }
    
    private async Task ShowPuttsTrendDialog()
    {
        if (_stats?.PuttsTrend18Hole is null || _stats.PuttsTrend18Hole.Count < 2)
        {
            return;
        }
        
        await DialogService.OpenAsync<PuttsTrendDialog>("Putting Trend (18-Hole Rounds)",
            new Dictionary<string, object>
            {
                { "TrendData", _stats.PuttsTrend18Hole }
            },
            new DialogOptions
            {
                Width = "700px",
                CloseDialogOnOverlayClick = true,
                CloseDialogOnEsc = true
            });
    }
    
    private async Task ShowFirTrendDialog()
    {
        if (_stats?.FirTrend is null || _stats.FirTrend.Count < 2)
        {
            return;
        }
        
        await DialogService.OpenAsync<FirTrendDialog>("Fairways In Regulation Trend",
            new Dictionary<string, object>
            {
                { "TrendData", _stats.FirTrend }
            },
            new DialogOptions
            {
                Width = "700px",
                CloseDialogOnOverlayClick = true,
                CloseDialogOnEsc = true
            });
    }
    
    private async Task ShowGirTrendDialog()
    {
        if (_stats?.GirTrend is null || _stats.GirTrend.Count < 2)
        {
            return;
        }
        
        await DialogService.OpenAsync<GirTrendDialog>("Greens In Regulation Trend",
            new Dictionary<string, object>
            {
                { "TrendData", _stats.GirTrend }
            },
            new DialogOptions
            {
                Width = "700px",
                CloseDialogOnOverlayClick = true,
                CloseDialogOnEsc = true
            });
    }
}
