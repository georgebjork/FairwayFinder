@using FairwayFinder.Features.Data

@if (Round is null)
{
    <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false">
        No scorecard data available.
    </RadzenAlert>
}
else
{
    <div class="scorecard-wrapper">
        <table class="scorecard-table">
            <thead>
                <tr>
                    <th colspan="2">Hole</th>
                    @foreach (var hole in FrontNine)
                    {
                        <th class="hole-cell">@hole.HoleNumber</th>
                    }
                    <th class="total-cell" colspan="2">Out</th>
                    @foreach (var hole in BackNine)
                    {
                        <th class="hole-cell">@hole.HoleNumber</th>
                    }
                    <th class="total-cell" colspan="2">In</th>
                    <th class="total-cell" colspan="2">Total</th>
                </tr>
            </thead>
            <tbody>
                <!-- Yardage Row -->
                <tr>
                    <th colspan="2">@Round.Teebox.TeeboxName</th>
                    @foreach (var hole in FrontNine)
                    {
                        <td class="hole-cell">@hole.Yardage</td>
                    }
                    <td class="total-cell" colspan="2">@Round.Teebox.YardageOut</td>
                    @foreach (var hole in BackNine)
                    {
                        <td class="hole-cell">@hole.Yardage</td>
                    }
                    <td class="total-cell" colspan="2">@Round.Teebox.YardageIn</td>
                    <td class="total-cell" colspan="2">@Round.Teebox.YardageTotal</td>
                </tr>

                <!-- Handicap Row -->
                <tr>
                    <th colspan="2">Handicap</th>
                    @foreach (var hole in FrontNine)
                    {
                        <td class="hole-cell">@hole.Handicap</td>
                    }
                    <td class="total-cell" colspan="2">&nbsp;</td>
                    @foreach (var hole in BackNine)
                    {
                        <td class="hole-cell">@hole.Handicap</td>
                    }
                    <td class="total-cell" colspan="2">&nbsp;</td>
                    <td class="total-cell" colspan="2">@Round.Teebox.Slope / @Round.Teebox.Rating</td>
                </tr>

                <!-- Par Row -->
                <tr>
                    <th colspan="2">Par</th>
                    @foreach (var hole in FrontNine)
                    {
                        <td class="hole-cell">@hole.Par</td>
                    }
                    <td class="total-cell" colspan="2">@Round.ParOut</td>
                    @foreach (var hole in BackNine)
                    {
                        <td class="hole-cell">@hole.Par</td>
                    }
                    <td class="total-cell" colspan="2">@Round.ParIn</td>
                    <td class="total-cell" colspan="2">@Round.Teebox.Par</td>
                </tr>

                <!-- Score Row -->
                <tr class="score-row">
                    <th colspan="2">Score</th>
                    @foreach (var hole in FrontNine)
                    {
                        <td class="hole-cell score-cell">
                            @if (hole.Score.HasValue)
                            {
                                <span class="score-value">@hole.Score</span>
                                @GetScoreIndicatorSvg(hole.ScoreToPar)
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>
                    }
                    <td class="total-cell" colspan="2">@(Round.ScoreOut > 0 ? Round.ScoreOut : "-")</td>
                    @foreach (var hole in BackNine)
                    {
                        <td class="hole-cell score-cell">
                            @if (hole.Score.HasValue)
                            {
                                <span class="score-value">@hole.Score</span>
                                @GetScoreIndicatorSvg(hole.ScoreToPar)
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>
                    }
                    <td class="total-cell" colspan="2">@(Round.ScoreIn > 0 ? Round.ScoreIn : "-")</td>
                    <td class="total-cell" colspan="2">@Round.Score</td>
                </tr>

                @if (Round.UsingHoleStats)
                {
                    <!-- Fairways Row -->
                    <tr>
                        <th colspan="2">Fairways</th>
                        @foreach (var hole in FrontNine)
                        {
                            <td class="hole-cell">
                                @if (hole.Par <= 3)
                                {
                                    <!-- Par 3 or less - no fairway -->
                                }
                                else if (hole.Stats?.HitFairway == true)
                                {
                                    <RadzenIcon Icon="check_circle" Style="color: var(--rz-success);" />
                                }
                                else if (hole.Stats?.HitFairway == false)
                                {
                                    @GetMissIcon(hole.Stats?.MissFairwayType)
                                }
                            </td>
                        }
                        <td class="total-cell" colspan="2">@Round.FairwaysHitOut</td>
                        @foreach (var hole in BackNine)
                        {
                            <td class="hole-cell">
                                @if (hole.Par <= 3)
                                {
                                    <!-- Par 3 or less - no fairway -->
                                }
                                else if (hole.Stats?.HitFairway == true)
                                {
                                    <RadzenIcon Icon="check_circle" Style="color: var(--rz-success);" />
                                }
                                else if (hole.Stats?.HitFairway == false)
                                {
                                    @GetMissIcon(hole.Stats?.MissFairwayType)
                                }
                            </td>
                        }
                        <td class="total-cell" colspan="2">@Round.FairwaysHitIn</td>
                        <td class="total-cell" colspan="2">@Round.FairwaysHit / @Round.FairwaysTotal</td>
                    </tr>

                    <!-- GIR Row -->
                    <tr>
                        <th colspan="2">GIR</th>
                        @foreach (var hole in FrontNine)
                        {
                            <td class="hole-cell">
                                @if (hole.Stats?.HitGreen == true)
                                {
                                    <RadzenIcon Icon="check_circle" Style="color: var(--rz-success);" />
                                }
                                else if (hole.Stats?.HitGreen == false)
                                {
                                    @GetMissIcon(hole.Stats?.MissGreenType)
                                }
                            </td>
                        }
                        <td class="total-cell" colspan="2">@Round.GreensHitOut</td>
                        @foreach (var hole in BackNine)
                        {
                            <td class="hole-cell">
                                @if (hole.Stats?.HitGreen == true)
                                {
                                    <RadzenIcon Icon="check_circle" Style="color: var(--rz-success);" />
                                }
                                else if (hole.Stats?.HitGreen == false)
                                {
                                    @GetMissIcon(hole.Stats?.MissGreenType)
                                }
                            </td>
                        }
                        <td class="total-cell" colspan="2">@Round.GreensHitIn</td>
                        <td class="total-cell" colspan="2">@Round.GreensHit / @Round.GreensTotal</td>
                    </tr>

                    <!-- Putts Row -->
                    <tr>
                        <th colspan="2">Putts</th>
                        @foreach (var hole in FrontNine)
                        {
                            <td class="hole-cell">@(hole.Stats?.NumberOfPutts?.ToString() ?? "")</td>
                        }
                        <td class="total-cell" colspan="2">@Round.PuttsOut</td>
                        @foreach (var hole in BackNine)
                        {
                            <td class="hole-cell">@(hole.Stats?.NumberOfPutts?.ToString() ?? "")</td>
                        }
                        <td class="total-cell" colspan="2">@Round.PuttsIn</td>
                        <td class="total-cell" colspan="2">@Round.TotalPutts</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<style>
    .scorecard-wrapper {
        width: 100%;
        overflow-x: auto;
    }

    .scorecard-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
        min-width: 900px;
        border-top: 1px solid var(--rz-text-disabled-color);
        border-bottom: 1px solid var(--rz-text-disabled-color);
        border-left: 1px solid var(--rz-text-disabled-color);
        border-right: 1px solid var(--rz-text-disabled-color);
    }

    .scorecard-table th,
    .scorecard-table td {
        padding: 0.5rem 0.25rem;
        text-align: center;
        border-top: 1px solid var(--rz-text-disabled-color);
        border-bottom: 1px solid var(--rz-text-disabled-color);
        border-left: none;
        border-right: none;
    }

    .scorecard-table th:first-child,
    .scorecard-table td:first-child {
        border-left: 1px solid var(--rz-text-disabled-color);
    }

    .scorecard-table th:last-child,
    .scorecard-table td:last-child {
        border-right: 1px solid var(--rz-text-disabled-color);
    }

    .scorecard-table thead th {
        background-color: var(--rz-base-background-color);
        font-weight: 600;
    }

    .scorecard-table tbody th {
        text-align: left;
        padding-left: 0.5rem;
        background-color: var(--rz-base-background-color);
        font-weight: 600;
        min-width: 80px;
    }

    .scorecard-table .hole-cell {
        min-width: 36px;
        width: 36px;
    }

    .scorecard-table .total-cell {
        font-weight: 600;
        background-color: var(--rz-base-background-color);
        min-width: 45px;
    }

    .scorecard-table .score-row {
        font-weight: 600;
        font-size: 1rem;
    }

    .scorecard-table .score-cell {
        position: relative;
    }

    .scorecard-table .score-value {
        position: relative;
        z-index: 1;
    }

    .scorecard-table .score-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        height: 80%;
        pointer-events: none;
    }
</style>

@code {
    [Parameter]
    public RoundResponse? Round { get; set; }

    private IEnumerable<RoundHole> FrontNine => Round?.Holes.Where(h => h.HoleNumber <= 9) ?? Enumerable.Empty<RoundHole>();
    private IEnumerable<RoundHole> BackNine => Round?.Holes.Where(h => h.HoleNumber > 9) ?? Enumerable.Empty<RoundHole>();

    private MarkupString GetScoreIndicatorSvg(int? scoreToPar)
    {
        if (!scoreToPar.HasValue) return new MarkupString("");

        var strokeColor = "var(--rz-text-color)";

        if (scoreToPar.Value <= -2)
        {
            // Eagle or better - double circle
            return new MarkupString($@"
                <svg class=""score-indicator"" xmlns=""http://www.w3.org/2000/svg"" viewBox=""0 0 100 100"">
                    <circle cx=""50"" cy=""50"" r=""38"" stroke-width=""3"" fill=""none"" style=""stroke: {strokeColor};""/>
                    <circle cx=""50"" cy=""50"" r=""28"" stroke-width=""2"" fill=""none"" style=""stroke: {strokeColor};""/>
                </svg>");
        }
        else if (scoreToPar.Value == -1)
        {
            // Birdie - single circle
            return new MarkupString($@"
                <svg class=""score-indicator"" xmlns=""http://www.w3.org/2000/svg"" viewBox=""0 0 100 100"">
                    <circle cx=""50"" cy=""50"" r=""38"" stroke-width=""3"" fill=""none"" style=""stroke: {strokeColor};""/>
                </svg>");
        }
        else if (scoreToPar.Value == 0)
        {
            // Par - no indicator
            return new MarkupString("");
        }
        else if (scoreToPar.Value == 1)
        {
            // Bogey - single square
            return new MarkupString($@"
                <svg class=""score-indicator"" xmlns=""http://www.w3.org/2000/svg"" viewBox=""0 0 100 100"">
                    <rect x=""10"" y=""10"" width=""80"" height=""80"" stroke-width=""3"" fill=""none"" style=""stroke: {strokeColor};""/>
                </svg>");
        }
        else
        {
            // Double bogey or worse - double square
            return new MarkupString($@"
                <svg class=""score-indicator"" xmlns=""http://www.w3.org/2000/svg"" viewBox=""0 0 100 100"">
                    <rect x=""10"" y=""10"" width=""80"" height=""80"" stroke-width=""3"" fill=""none"" style=""stroke: {strokeColor};""/>
                    <rect x=""20"" y=""20"" width=""60"" height=""60"" stroke-width=""2"" fill=""none"" style=""stroke: {strokeColor};""/>
                </svg>");
        }
    }

    private RenderFragment GetMissIcon(int? missType) => builder =>
    {
        var icon = missType switch
        {
            1 => "arrow_circle_left",   // Left
            2 => "arrow_circle_right",  // Right
            3 => "arrow_circle_down",   // Short
            4 => "arrow_circle_up",     // Long
            _ => "cancel"               // Generic miss
        };

        builder.OpenComponent<RadzenIcon>(0);
        builder.AddAttribute(1, "Icon", icon);
        builder.AddAttribute(2, "Style", "color: var(--rz-danger);");
        builder.CloseComponent();
    };
}
